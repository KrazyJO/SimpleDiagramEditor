//this is a port the awesome bbq applicaiton from programming methedologoies

class Person {

    constructor(name) {
        this.name = name;
        this.items = [];
    }

    addItem(name, price) {
        console.log("add item")
        let item = new Item(name, price);
        this.items.push(item);
    }
}

class Item {

    constructor(name, price) {
        this.name = name;
        this.price = price;
    }
}

class Application {

    //initialize with empty object
    constructor() {
        //initialize rootModle
        let bob = new Person("Bob");
        bob.addItem('beer', 10);
        bob.addItem('crackers', 15);

        window.rootModle = {
            total : 42,
            share : 21,
            persons : [
                bob,
                new Person("Alice")
            ]
        };
    }

    renderApplication() {
        let application = document.getElementById('bbqapplication');
        application.innerHTML = '';

        let container = document.createElement('div');

        //render persons
        let renderedPerson;
        for (let i = 0; i < window.rootModle.persons.length; i++) {
            renderedPerson = this.renderPerson(window.rootModle.persons[i]);
            container.appendChild(renderedPerson);
        }

        container.appendChild(this.renderAddPersonArea());

        application.appendChild(container);
    }

    renderAddPersonArea() {
        let divAddPerson = document.createElement('div');
        divAddPerson.setAttribute('class', 'bbq-addPerson');

        let inputAddPerson = document.createElement('input');
        inputAddPerson.setAttribute('id', 'inputNewPerson');
        inputAddPerson.setAttribute('placeholder', 'Name');

        let buttonAddPerson = document.createElement('button');
        buttonAddPerson.innerText = "Add Person";
        buttonAddPerson.addEventListener('click', addPerson);

        divAddPerson.appendChild(inputAddPerson);
        divAddPerson.appendChild(buttonAddPerson);

        return divAddPerson;
    }

    renderPerson(person) {
        let element = document.createElement('div');
        element.setAttribute('class', 'bbq-person');
        let name = document.createElement('div');
        name.setAttribute('class', 'bbq-person-name');

        element.appendChild(name);
        element.innerText = person.name;

        person.items.forEach((item) => {
            element.appendChild(this.renderItem(item));
        });

        this.renderAddItem(element, person);

        return element;

    }

    addItemListener(button, person) {
        button.addEventListener('click', function(evt) {
            addItem(person, evt);
        }.bind(this));
    }

    renderItem(item) {
        let element = document.createElement('div');
        element.setAttribute('class', 'bbq-item');
        
        let itemName = document.createElement('div');
        itemName.setAttribute('class', 'bbq-itemName');
        itemName.innerText = item.name;

        let itemPrice = document.createElement('div');
        itemPrice.setAttribute('class', 'bbq-itemPrice');
        itemPrice.innerText = item.price;

        element.appendChild(itemName);
        element.appendChild(itemPrice);

        return element;

    }

    renderAddItem(element, person) {
        let container = document.createElement('div');
        container.setAttribute('class', 'bbq-addItem');
        let firstLine = document.createElement('div');
        let name = document.createElement('input');
        name.setAttribute('placeholder', 'item name');
        name.setAttribute('class', 'bbq-addItem-name');
        let price = document.createElement('input');
        price.setAttribute('placeholder', 'price');
        price.setAttribute('class', 'bbq-addItem-price');
        firstLine.appendChild(name);
        firstLine.appendChild(price);

        let btn = document.createElement('button');
        btn.setAttribute('class', 'bbq-addItem-btn');
        btn.innerText = 'add item';
        this.addItemListener(btn, person);

        container.appendChild(firstLine);
        container.appendChild(btn);

        element.appendChild(container);
    }
}

class Controller {
    addPerson() {
        console.log("add person pressed");
    }
}

let controller = new Controller();
let application = new Application();

window.onload = function() {
    application.renderApplication();
}; 

//@debug
function addPerson() {
    let name = document.getElementById('inputNewPerson').value;
    window.rootModle.persons.push(new Person(name));
    application.renderApplication();
}

function addItem(person, event) {
    let parent = event.target.parentElement;
    let price = parent.getElementsByClassName('bbq-addItem-price')[0].value;
    let name = parent.getElementsByClassName('bbq-addItem-name')[0].value;
    let item = new Item(name, price);
    person.items.push(item);
    application.renderApplication();
}